{% extends "base.html" %}
{% block title %}Veri Tablosu{% endblock %}

{% block head_extra %}
<meta charset="UTF-8">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap3.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/3.0.2/css/buttons.bootstrap3.min.css"/>
<style>
    body {
        font-family: "Segoe UI", Arial, Helvetica, sans-serif;
    }
    .filter-input {
        width: 100%; 
        box-sizing: border-box; 
        padding: 4px;
        margin-top: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    .table-responsive {
        width: 100% !important;
        overflow-x: auto;
    }
    #data_table {
        width: 100% !important;
        table-layout: auto;
        border-collapse: collapse;
    }
    #data_table th, #data_table td {
        white-space: nowrap;
        text-align: center;
        padding: 6px 10px;
    }
    #data_table thead th {
        background-color: #f8f9fa;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<h2 class="mb-4">2. Etiketlenecek Veri Tablosu</h2>

{% if messages %}
    {% for msg in messages %}
    <div class="alert alert-{{ msg.category }}">{{ msg.message }}</div>
    {% endfor %}
{% endif %}

<div class="alert alert-info" role="alert">
    <strong>Gelişmiş Filtreleme:</strong> Her sütunun altındaki kutucuktan ayrı ayrı filtreleme yapabilirsiniz.
    Örneğin 'Marka' sütununa 'Philips' yazıp filtreledikten sonra, 'Model' sütununa 'MX' yazıp sadece MX modellerini görebilirsiniz.
</div>

<form method="POST" action="/prepare_for_print">
    <div class="d-flex justify-content-between mb-3">
        <button type="submit" class="btn btn-success" {% if not template_set %}disabled{% endif %}>
            <i class="bi bi-printer"></i>
            {% if template_set %}
                Seçilen Satırları Yazdırmaya Hazırla
            {% else %}
                Şablonu Ayarlayın
            {% endif %}
        </button>
        <div id="colvis-container" class="btn-group"></div>
    </div>

    <div class="table-responsive">
        <table id="data_table" class="table table-striped table-hover table-sm">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select_all"></th>
                    {% for col in columns %}
                    <th>{{ col }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tfoot>
                <tr>
                    <th></th>
                    {% for col in columns %}
                    <th><input type="text" placeholder="{{ col }} filtrele" class="filter-input" data-column-index="{{ loop.index }}"></th>
                    {% endfor %}
                </tr>
            </tfoot>
            <tbody>
                {% for row in data %}
                <tr>
                    <td><input type="checkbox" name="selected_rows_checkbox" value="{{ loop.index0 }}"></td>
                    {% for col in columns %}
                    <td>{{ row[col] }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script> 
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.min.js"></script>
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/3.0.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.colVis.min.js"></script>

<script>
$(document).ready(function() {
    var table = $('#data_table').DataTable({
        order: [],
        columnDefs: [
            { orderable: false, targets: 0 },
            { searchable: false, targets: 0 },
            { searchable: true, targets: '_all' }
        ],
        language: {
            url: "//cdn.datatables.net/plug-ins/2.0.8/i18n/tr.json"
        },
        layout: {
            topStart: '',
            topEnd: {
                buttons: [
                    {
                        extend: 'colvis',
                        text: 'Sütunları Göster/Gizle',
                        className: 'btn btn-outline-secondary'
                    }
                ]
            },
            bottomEnd: 'info',
            bottomStart: 'paging'
        }
    });

    table.buttons().container().appendTo('#colvis-container');
    $('#data_table_filter').hide();

    $('.filter-input').on('keyup change', function() {
        var colIndex = $(this).data('column-index');
        table.column(colIndex).search(this.value, false, true).draw();
    });

    var selectedRows = new Set();

    $('#data_table tbody').on('change', 'input[name="selected_rows_checkbox"]', function() {
        var value = $(this).val();
        if (this.checked) {
            selectedRows.add(value);
        } else {
            selectedRows.delete(value);
        }
        updateButton();
        updateSelectAll();
    });

    $('#select_all').on('click', function() {
        var isChecked = this.checked;
        table.rows({ search: 'applied', page: 'current' }).nodes().to$()
            .find('input[name="selected_rows_checkbox"]').each(function() {
                this.checked = isChecked;
                var value = $(this).val();
                if (isChecked) selectedRows.add(value);
                else selectedRows.delete(value);
            });
        updateButton();
    });

    function updateSelectAll() {
        var visible = table.rows({ search: 'applied', page: 'current' }).nodes().to$().find('input[name="selected_rows_checkbox"]');
        var checkedCount = visible.filter(':checked').length;
        $('#select_all').prop('checked', checkedCount > 0 && checkedCount === visible.length);
        $('#select_all').prop('indeterminate', checkedCount > 0 && checkedCount < visible.length);
    }

    $('form').on('submit', function() {
        $('input[name="selected_rows"]').remove();
        selectedRows.forEach(function(v) {
            $('<input>').attr({ type: 'hidden', name: 'selected_rows', value: v }).appendTo('form');
        });
    });

    function updateButton() {
        var button = $('.btn-success[type="submit"]');
        var templateIsSet = {{ template_set | safe }};
        if (selectedRows.size > 0 && templateIsSet) {
            button.prop('disabled', false);
            button.html('<i class="bi bi-printer"></i> Seçilen ' + selectedRows.size + ' Satırı Yazdırmaya Hazırla');
        } else {
            button.prop('disabled', true);
            button.html('<i class="bi bi-printer"></i> Satırları Seçin');
        }
    }

    table.on('draw', function() {
        table.rows({ page: 'current' }).nodes().to$().find('input[name="selected_rows_checkbox"]').each(function() {
            var value = $(this).val();
            this.checked = selectedRows.has(value);
        });
        updateSelectAll();
    });

    updateButton();
});
</script>
{% endblock %}
